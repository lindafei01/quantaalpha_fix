# AlphaAgent å®éªŒè¶…å‚æ•°é…ç½®æ–‡æ¡£

> æœ¬æ–‡æ¡£è¯¦ç»†æ•´ç†äº† `è¿è¡Œå®éªŒ.sh` åŠå…¶ç›¸å…³é…ç½®æ–‡ä»¶ä¸­çš„æ‰€æœ‰è¶…å‚æ•°è®¾ç½®ã€‚

---

## ç›®å½•

1. [æ¨¡å‹é…ç½®](#1-æ¨¡å‹é…ç½®)
2. [è§„åˆ’é…ç½®](#2-è§„åˆ’é…ç½®-planning)
3. [æ‰§è¡Œé…ç½®](#3-æ‰§è¡Œé…ç½®-execution)
4. [è¿›åŒ–é…ç½®](#4-è¿›åŒ–é…ç½®-evolution)
5. [å› å­ç”Ÿæˆé…ç½®](#5-å› å­ç”Ÿæˆé…ç½®-factor)
6. [å›æµ‹é…ç½®](#6-å›æµ‹é…ç½®-backtest)
7. [æ•°æ®é…ç½®](#7-æ•°æ®é…ç½®-data)
8. [æ¨¡å‹è®­ç»ƒé…ç½®](#8-æ¨¡å‹è®­ç»ƒé…ç½®-lgbmodel)
9. [äº¤æ˜“ç­–ç•¥é…ç½®](#9-äº¤æ˜“ç­–ç•¥é…ç½®-strategy)
10. [LLMé…ç½®](#10-llmé…ç½®)
11. [æ—¥å¿—é…ç½®](#11-æ—¥å¿—é…ç½®-logging)
12. [è·¯å¾„é…ç½®](#12-è·¯å¾„é…ç½®)

---

## 1. æ¨¡å‹é…ç½®

### 1.1 LLM æ¨¡å‹é¢„è®¾

é€šè¿‡ `MODEL_PRESET` ç¯å¢ƒå˜é‡å¿«é€Ÿåˆ‡æ¢æ¨¡å‹ï¼š

| é¢„è®¾åç§° | æ¨ç†æ¨¡å‹ | å¯¹è¯æ¨¡å‹ | API ç«¯ç‚¹ |
|---------|---------|---------|----------|
| `gemini` | `google/gemini-3-pro-preview` | `google/gemini-3-pro-preview` | OpenRouter |
| `deepseek` | `deepseek/deepseek-v3.2` | `deepseek/deepseek-v3.2` | OpenRouter |
| `deepseek_aliyun` | `deepseek-v3.2` | `deepseek-v3.2` | é˜¿é‡Œäº‘ DashScope |
| `claude` | `anthropic/claude-sonnet-4.5` | `anthropic/claude-sonnet-4.5` | OpenRouter |
| `gpt` | `openai/gpt-5.2` | `openai/gpt-5.2` | OpenRouter |
| `qwen` | `qwen3-235b-a22b-instruct-2507` | `qwen3-235b-a22b-instruct-2507` | é˜¿é‡Œäº‘ DashScope |

### 1.2 ç¯å¢ƒå˜é‡è¦†ç›–

```bash
REASONING_MODEL=<model_name>   # æ¨ç†æ¨¡å‹
CHAT_MODEL=<model_name>        # å¯¹è¯æ¨¡å‹
OPENAI_API_KEY=<api_key>       # API å¯†é’¥
OPENAI_BASE_URL=<base_url>     # API ç«¯ç‚¹
```

---

## 2. è§„åˆ’é…ç½® (Planning)

> é…ç½®æ–‡ä»¶: `alphaagent/app/qlib_rd_loop/run_config.yaml`

| å‚æ•°å | é»˜è®¤å€¼ | ç±»å‹ | è¯´æ˜ |
|--------|--------|------|------|
| `enabled` | `true` | bool | å¯ç”¨å¹¶è¡Œè§„åˆ’åŠŸèƒ½ |
| `num_directions` | **10** | int | ğŸ”¥**è¶…å‚** å¹¶è¡Œæ¢ç´¢æ–¹å‘æ•°é‡ |
| `max_attempts` | `5` | int | è§„åˆ’æœ€å¤§é‡è¯•æ¬¡æ•° |
| `use_llm` | `true` | bool | æ˜¯å¦ä½¿ç”¨ LLM ç”Ÿæˆæ–¹å‘ |
| `allow_fallback` | `true` | bool | LLM å¤±è´¥æ—¶æ˜¯å¦ä½¿ç”¨å†…ç½®æ¨¡æ¿å›é€€ |
| `prompt_file` | `planning_prompts.yaml` | str | è§„åˆ’æç¤ºè¯æ–‡ä»¶è·¯å¾„ |

---

## 3. æ‰§è¡Œé…ç½® (Execution)

| å‚æ•°å | é»˜è®¤å€¼ | ç±»å‹ | è¯´æ˜ |
|--------|--------|------|------|
| `max_loops` | `11` | int | æœ€å¤§å¾ªç¯è¿­ä»£æ¬¡æ•° |
| `steps_per_loop` | `5` | int | æ¯å¾ªç¯æ­¥æ•° (å›ºå®š: æå‡ºå‡è®¾/æ„å»ºå› å­/è®¡ç®—/å›æµ‹/åé¦ˆ) |
| `step_n` | `null` | int | æ€»æ­¥æ•° (æœ€é«˜ä¼˜å…ˆçº§ï¼Œè¦†ç›– max_loops Ã— steps_per_loop) |
| `use_local` | `true` | bool | ä½¿ç”¨æœ¬åœ°ç¯å¢ƒå›æµ‹ (vs Docker) |
| `parallel_execution` | `false` | bool | æ˜¯å¦ä½¿ç”¨å¤šè¿›ç¨‹å¹¶è¡Œè¿è¡Œåˆ†æ”¯ |
| `branch_log_root` | `/mnt/DATA/quantagent/AlphaAgent/log` | str | åˆ†æ”¯æ—¥å¿—æ ¹ç›®å½• |
| `branch_log_prefix` | `branch` | str | åˆ†æ”¯æ—¥å¿—å‰ç¼€ |

---

## 4. è¿›åŒ–é…ç½® (Evolution)

> ğŸ”¥ æ ¸å¿ƒè¶…å‚æ•°åŒºåŸŸ

| å‚æ•°å | é»˜è®¤å€¼ | ç±»å‹ | è¯´æ˜ |
|--------|--------|------|------|
| `enabled` | `true` | bool | å¯ç”¨è¿›åŒ–æ¨¡å¼ |
| `mutation_enabled` | `true` | bool | å¯ç”¨å˜å¼‚é˜¶æ®µ |
| `crossover_enabled` | `true` | bool | å¯ç”¨äº¤å‰é˜¶æ®µ |
| `max_rounds` | **11** | int | ğŸ”¥**è¶…å‚** æœ€å¤§è¿›åŒ–è½®æ•° (åŒ…æ‹¬åŸå§‹è½®) |
| `crossover_size` | **2** | int | ğŸ”¥**è¶…å‚** æ¯æ¬¡äº¤å‰é€‰æ‹©çš„çˆ¶ä»£æ•°é‡ (å¯é€‰ 2 æˆ– 3) |
| `crossover_n` | **10** | int | ğŸ”¥**è¶…å‚** æ¯è½®äº¤å‰ç”Ÿæˆçš„ç»„åˆæ•°é‡ |
| `parallel_enabled` | `false` | bool | è¿›åŒ–é˜¶æ®µå†…å¹¶è¡Œæ‰§è¡Œ |
| `prefer_diverse_crossover` | `true` | bool | åå¥½å¤šæ ·åŒ–çš„äº¤å‰ç»„åˆ |
| `parent_selection_strategy` | `best` | str | çˆ¶ä»£é€‰æ‹©ç­–ç•¥ |
| `top_percent_threshold` | `0.3` | float | Top ç™¾åˆ†æ¯”é˜ˆå€¼ (é…åˆ `top_percent_plus_random` ç­–ç•¥) |
| `fresh_start` | `true` | bool | æ˜¯å¦ä»ç©ºè½¨è¿¹æ± å¼€å§‹ |
| `cleanup_on_finish` | `false` | bool | å®éªŒç»“æŸåæ˜¯å¦æ¸…ç†è½¨è¿¹æ±  |
| `prompt_file` | `evolution_prompts.yaml` | str | è¿›åŒ–æç¤ºè¯æ–‡ä»¶è·¯å¾„ |

### 4.1 çˆ¶ä»£é€‰æ‹©ç­–ç•¥

| ç­–ç•¥å | è¯´æ˜ |
|--------|------|
| `best` | ä¼˜å…ˆé€‰æ‹©è¡¨ç°æœ€å¥½çš„è½¨è¿¹ |
| `random` | éšæœºé€‰æ‹© |
| `weighted` | æ€§èƒ½åŠ æƒé‡‡æ · (æ€§èƒ½è¶Šé«˜æƒé‡è¶Šé«˜) |
| `weighted_inverse` | é€†æ€§èƒ½åŠ æƒé‡‡æ · (é¼“åŠ±æ¢ç´¢å·®è½¨è¿¹) |
| `top_percent_plus_random` | å‰ 30% ä¿è¯é€‰ä¸­ + å‰©ä½™éšæœºå¡«å…… |

### 4.2 è¿›åŒ–æµç¨‹

```
Round 0: åŸå§‹è½® (Original) â†’ ç”Ÿæˆåˆå§‹å› å­
Round 1: å˜å¼‚è½® (Mutation) â†’ å¯¹ç°æœ‰å› å­å˜å¼‚
Round 2: äº¤å‰è½® (Crossover) â†’ ç»„åˆä¸åŒå› å­
Round 3: å˜å¼‚è½® (Mutation)
Round 4: äº¤å‰è½® (Crossover)
...
```

---

## 5. å› å­ç”Ÿæˆé…ç½® (Factor)

| å‚æ•°å | é»˜è®¤å€¼ | ç±»å‹ | è¯´æ˜ |
|--------|--------|------|------|
| `factors_per_hypothesis` | **3** | int | ğŸ”¥ æ¯ä¸ªå‡è®¾ç”Ÿæˆçš„å› å­æ•°é‡ |

### 5.1 å¤æ‚åº¦çº¦æŸ

| å‚æ•°å | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|--------|------|
| `symbol_length_threshold` | **250** | ğŸ”¥ å› å­è¡¨è¾¾å¼æœ€å¤§å­—ç¬¦é•¿åº¦ (é˜²æ­¢è¿‡æ‹Ÿåˆå…³é”®å‚æ•°) |
| `base_features_threshold` | `6` | ä¸åŒåŸºç¡€ç‰¹å¾æœ€å¤§æ•°é‡ ($close, $open ç­‰) |
| `free_args_ratio_threshold` | `0.5` | æœ€å¤§è‡ªç”±å‚æ•°æ¯”ä¾‹ (æ•°å€¼å¸¸é‡/æ€»èŠ‚ç‚¹æ•°) |

### 5.2 é‡å¤æ€§æ£€æŸ¥

| å‚æ•°å | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|--------|------|
| `duplication.enabled` | `true` | å¯ç”¨é‡å¤æ€§æ£€æŸ¥ |
| `duplication.threshold` | `5` | é‡å¤å­æ ‘å¤§å°é˜ˆå€¼ |
| `duplication.factor_zoo_path` | `null` | å› å­åº“æ–‡ä»¶è·¯å¾„ |

---

## 6. å›æµ‹é…ç½® (Backtest)

| å‚æ•°å | é»˜è®¤å€¼ | ç±»å‹ | è¯´æ˜ |
|--------|--------|------|------|
| `use_docker` | `false` | bool | ä½¿ç”¨ Docker ç¯å¢ƒå›æµ‹ |
| `timeout` | **800** | int | ğŸ”¥ æ¯æ¬¡å›æµ‹è¶…æ—¶æ—¶é—´ (ç§’) |
| `qlib.config_name` | `conf.yaml` | str | Qlib é…ç½®æ–‡ä»¶å |

---

## 7. æ•°æ®é…ç½® (Data)

> é…ç½®æ–‡ä»¶: `alphaagent/scenarios/qlib/experiment/factor_template/conf.yaml`

### 7.1 Qlib åˆå§‹åŒ–

| å‚æ•°å | å€¼ | è¯´æ˜ |
|--------|-----|------|
| `provider_uri` | `~/.qlib/qlib_data/cn_data` | Qlib æ•°æ®è·¯å¾„ |
| `region` | `cn` | å¸‚åœºåŒºåŸŸ (cn/us) |

### 7.2 å¸‚åœºé…ç½®

| å‚æ•°å | å€¼ | è¯´æ˜ |
|--------|-----|------|
| `market` | **csi300** | ğŸ”¥ è‚¡ç¥¨æ±  (æ²ªæ·±300) |
| `benchmark` | **SH000300** | ğŸ”¥ åŸºå‡†æŒ‡æ•° (æ²ªæ·±300æŒ‡æ•°) |

### 7.3 æ—¶é—´èŒƒå›´

| æ•°æ®é›† | æ—¶é—´èŒƒå›´ | è¯´æ˜ |
|--------|----------|------|
| **æ•´ä½“æ•°æ®** | 2016-01-01 ~ 2025-12-26 | å…¨éƒ¨æ•°æ®èŒƒå›´ |
| **è®­ç»ƒé›†** | 2016-01-01 ~ 2020-12-31 | æ¨¡å‹è®­ç»ƒ (5å¹´) |
| **éªŒè¯é›†** | 2021-01-01 ~ 2021-12-31 | æ¨¡å‹éªŒè¯ (1å¹´) |
| **æµ‹è¯•é›†** | 2022-01-01 ~ 2025-12-26 | å›æµ‹è¯„ä¼° (çº¦4å¹´) |

### 7.4 æ•°æ®å¤„ç†å™¨

```yaml
learn_processors:
  - Fillna (feature)      # å¡«å……ç¼ºå¤±å€¼
  - ProcessInf            # å¤„ç†æ— ç©·å€¼
  - DropnaLabel           # åˆ é™¤ç©ºæ ‡ç­¾
  - CSRankNorm (feature)  # æˆªé¢æ’åæ ‡å‡†åŒ– (ç‰¹å¾)
  - CSRankNorm (label)    # æˆªé¢æ’åæ ‡å‡†åŒ– (æ ‡ç­¾)

infer_processors:
  - Fillna (feature)
  - ProcessInf
  - CSRankNorm (feature)
  - CSRankNorm (label)
```

### 7.5 æ ‡ç­¾å®šä¹‰

```python
label = "Ref($close, -2) / Ref($close, -1) - 1"  # T+2 æ—¥æ”¶ç›Šç‡
```

---

## 8. æ¨¡å‹è®­ç»ƒé…ç½® (LGBModel)

> LightGBM æ¨¡å‹è¶…å‚æ•°

| å‚æ•°å | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|--------|------|
| `loss` | `mse` | æŸå¤±å‡½æ•° |
| `learning_rate` | **0.05** | ğŸ”¥ å­¦ä¹ ç‡ |
| `max_depth` | **8** | ğŸ”¥ æ ‘æœ€å¤§æ·±åº¦ |
| `num_leaves` | **210** | ğŸ”¥ å¶èŠ‚ç‚¹æ•°é‡ |
| `colsample_bytree` | `0.8879` | åˆ—é‡‡æ ·æ¯”ä¾‹ |
| `subsample` | `0.8789` | è¡Œé‡‡æ ·æ¯”ä¾‹ |
| `lambda_l1` | `205.6999` | L1 æ­£åˆ™åŒ– |
| `lambda_l2` | `580.9768` | L2 æ­£åˆ™åŒ– |
| `num_threads` | `20` | å¹¶è¡Œçº¿ç¨‹æ•° |
| `early_stopping_round` | **50** | ğŸ”¥ æ—©åœè½®æ•° |
| `num_boost_round` | **500** | ğŸ”¥ æœ€å¤§è¿­ä»£è½®æ•° |

---

## 9. äº¤æ˜“ç­–ç•¥é…ç½® (Strategy)

### 9.1 TopkDropout ç­–ç•¥

| å‚æ•°å | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|--------|------|
| `topk` | **50** | ğŸ”¥ æŒä»“è‚¡ç¥¨æ•°é‡ |
| `n_drop` | **5** | ğŸ”¥ æ¯æ—¥æ·˜æ±°è‚¡ç¥¨æ•°é‡ |

### 9.2 äº¤æ˜“æˆæœ¬

| å‚æ•°å | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|--------|------|
| `account` | `100000000` | åˆå§‹èµ„é‡‘ (1äº¿) |
| `limit_threshold` | `0.095` | æ¶¨è·Œåœé˜ˆå€¼ (9.5%) |
| `deal_price` | `open` | æˆäº¤ä»·æ ¼ (å¼€ç›˜ä»·) |
| `open_cost` | **0.0005** | ğŸ”¥ ä¹°å…¥æˆæœ¬ (0.05%) |
| `close_cost` | **0.0015** | ğŸ”¥ å–å‡ºæˆæœ¬ (0.15%) |
| `min_cost` | `5` | æœ€å°äº¤æ˜“æˆæœ¬ (å…ƒ) |

---

## 10. LLM é…ç½®

| å‚æ•°å | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|--------|------|
| `factor_mining_timeout` | `999999` | å› å­æŒ–æ˜æ€»è¶…æ—¶ (ç§’) |
| `max_retries` | `3` | API è°ƒç”¨æœ€å¤§é‡è¯•æ¬¡æ•° |
| `retry_delay` | `1.0` | é‡è¯•é—´éš” (ç§’) |
| `json_mode_strict` | `true` | JSON æ¨¡å¼ä¸¥æ ¼æ€§ |

---

## 11. æ—¥å¿—é…ç½® (Logging)

| å‚æ•°å | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|--------|------|
| `level` | `INFO` | æ—¥å¿—çº§åˆ« (DEBUG/INFO/WARNING/ERROR) |
| `save_snapshots` | `true` | ä¿å­˜ä¸­é—´ä¼šè¯å¿«ç…§ |
| `save_trajectory_pool` | `true` | ä¿å­˜è½¨è¿¹æ± åˆ° JSON |

---

## 12. è·¯å¾„é…ç½®

### 12.1 å·¥ä½œç©ºé—´è·¯å¾„

```bash
# è‡ªåŠ¨ç”Ÿæˆ (é»˜è®¤)
WORKSPACE_PATH=/mnt/DATA/quantagent/QuantaAlpha/QuantaAlpha_workspace_exp_YYYYMMDD_HHMMSS
PICKLE_CACHE_FOLDER_PATH=/mnt/DATA/quantagent/AlphaAgent/pickle_cache_exp_YYYYMMDD_HHMMSS

# æ‰‹åŠ¨æŒ‡å®š
EXPERIMENT_ID=my_exp bash è¿è¡Œå®éªŒ.sh "æ–¹å‘"

# å…±äº«ç›®å½•æ¨¡å¼
EXPERIMENT_ID=shared bash è¿è¡Œå®éªŒ.sh "æ–¹å‘"
```

### 12.2 è¾“å‡ºæ–‡ä»¶

| æ–‡ä»¶ | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| å› å­åº“ | `all_factors_library.json` | é»˜è®¤è¾“å‡º |
| å› å­åº“ (å¸¦åç¼€) | `all_factors_library_{suffix}.json` | æŒ‡å®šåç¼€è¾“å‡º |
| é…ç½®æ–‡ä»¶ | `alphaagent/app/qlib_rd_loop/run_config.yaml` | ä¸»é…ç½®æ–‡ä»¶ |
| å›æµ‹é…ç½® | `alphaagent/scenarios/qlib/experiment/factor_template/conf.yaml` | Qlib é…ç½® |

---

## é™„å½•: å…³é”®è¶…å‚æ•°æ±‡æ€»

| ç±»åˆ« | å‚æ•° | é»˜è®¤å€¼ | å½±å“ |
|------|------|--------|------|
| **è§„åˆ’** | `num_directions` | 10 | åˆå§‹æ¢ç´¢æ–¹å‘æ•°é‡ |
| **è¿›åŒ–** | `max_rounds` | 11 | æ€»è¿›åŒ–è½®æ•° |
| **è¿›åŒ–** | `crossover_size` | 2 | äº¤å‰çˆ¶ä»£æ•°é‡ |
| **è¿›åŒ–** | `crossover_n` | 10 | æ¯è½®äº¤å‰ç»„åˆæ•° |
| **å› å­** | `factors_per_hypothesis` | 3 | æ¯å‡è®¾å› å­æ•° |
| **å› å­** | `symbol_length_threshold` | 250 | è¡¨è¾¾å¼é•¿åº¦ä¸Šé™ |
| **æ¨¡å‹** | `learning_rate` | 0.05 | LGB å­¦ä¹ ç‡ |
| **æ¨¡å‹** | `num_boost_round` | 500 | LGB è¿­ä»£æ¬¡æ•° |
| **ç­–ç•¥** | `topk` | 50 | æŒä»“è‚¡ç¥¨æ•° |
| **ç­–ç•¥** | `n_drop` | 5 | æ¯æ—¥è°ƒä»“æ•° |
| **æ•°æ®** | `market` | csi300 | è‚¡ç¥¨æ±  |
| **æ•°æ®** | `train` | 2016-2020 | è®­ç»ƒé›†èŒƒå›´ |
| **æ•°æ®** | `test` | 2022-2025 | æµ‹è¯•é›†èŒƒå›´ |

---

*æ–‡æ¡£ç”Ÿæˆæ—¶é—´: 2026-01-24*

